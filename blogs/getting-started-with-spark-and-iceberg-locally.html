<p><!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blog by Madhav</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>

    <div class="container pt-4 px-3">

        <nav class="navbar">
            <a class="navbar-text navbar-brand" href="/index.html">
                Madhav <br> Khandhar
            </a>
            <div class="social-icons">
                <a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;madhav-khandhar&#x2F;" target="_blank"><i class="navbar-icon bi bi-linkedin"></i></a>
                <a href="https:&#x2F;&#x2F;github.com&#x2F;Mvk122" target="_blank"><i class="navbar-icon bi bi-github"></i></a>
            </div>
        </nav></p>
<h1>Getting Started with Spark and Iceberg Locally</h1>
<p><a href="https://iceberg.apache.org/spark-quickstart/">The official quickstart guide</a> for using Apache Spark with Apache Iceberg recommends using <a href="https://hub.docker.com/r/tabulario/spark-iceberg">a docker image</a> to get started. While that's great for getting a playground environment to play with SparkSQL, it isn't representative of how you'd actually start a real project.</p>
<p>So here's how you'd actually create a Maven Java 17 project that's actually modular.</p>
<p>Firstly we want to get the relevant dependencies, Spark and Iceberg so lets just add this to our <code>pom.xml</code>:</p>

<pre>
<code class="language-xml">
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;
        &lt;artifactId&gt;spark-core_2.13&lt;/artifactId&gt;
        &lt;version&gt;3.5.5&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.iceberg&lt;/groupId&gt;
        &lt;artifactId&gt;iceberg-core&lt;/artifactId&gt;
        &lt;version&gt;1.9.2&lt;/version&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;repositories&gt;
    &lt;repository&gt;
        &lt;id&gt;central&lt;/id&gt;
        &lt;name&gt;Central Repository&lt;/name&gt;
        &lt;url&gt;https://repo1.maven.org/maven2&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;

</code>
</pre>
<p>Some Java code TODO yap</p>

<pre>
<code class="language-java">
package sparkplayground;

import org.apache.spark.sql.SparkSession;

public class Main {
    public static SparkSession createSparkSession() {
        return SparkSession.builder()
                .config(&quot;spark.sql.extensions&quot;, &quot;org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions&quot;)
                .config(&quot;spark.sql.catalog.hadoop_catalog&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)
                .config(&quot;spark.sql.catalog.hadoop_catalog.type&quot;, &quot;hadoop&quot;)
                .config(&quot;spark.sql.catalog.hadoop_catalog.warehouse&quot;, &quot;file:///database&quot;)
                .config(&quot;spark.master&quot;, &quot;local&quot;)
                .getOrCreate();
    }

    public static void main(String[] args) {
        SparkSession spark = createSparkSession();
        spark.sql(&quot;CREATE TABLE local.db.test (id BIGINT, name STRING) USING ICEBERG&quot;);
        System.out.println(&quot;Hello World&quot;);
    }
}

</code>
</pre>
<p>Running this on Java 17 will give us an exception:</p>

<pre>
<code class="language-">
Exception in thread &quot;main&quot; java.lang.IllegalAccessError: class org.apache.spark.storage.StorageUtils$ (in unnamed module @0x1a75e76a) cannot access class sun.nio.ch.DirectBuffer (in module java.base) because module java.base does not export sun.nio.ch to unnamed module @0x1a75e76a

</code>
</pre>
<p>We need to export <code>sun.nio.ch</code> in our Java config by adding VM options:</p>

<pre>
<code class="language-">
--add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/sun.nio.cs=ALL-UNNAMED --add-opens=java.base/sun.security.action=ALL-UNNAMED --add-opens=java.base/sun.util.calendar=ALL-UNNAMED --add-opens=java.security.jgss/sun.security.krb5=ALL-UNNAMED

</code>
</pre>
<p>
<footer class="fixed-bottom">
    <div style="display: flex; justify-content: center; margin: auto; width:100%">
        <p style="text-align: center;">Built with <a href="https:&#x2F;&#x2F;github.com&#x2F;Mvk122&#x2F;sitesy" target="_blank">Sitesy</a></p>
    </div>
</footer>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html></p>
